<%- include("../partials/header") %>

<div class="row">
  <div class="col-12">
    <h1>Create a New Report</h1>
    <p class="text-muted">Click on map to drop a pin, or use "Use my location".</p>
  </div>
</div>

<form id="reportForm" action="/reports" method="POST" class="mt-3">
  <div class="mb-3">
    <label for="title" class="form-label">Title</label>
    <input type="text" name="title" id="title" class="form-control" required />
  </div>

  <div class="mb-3">
    <label for="description" class="form-label">Description</label>
    <textarea name="description" id="description" rows="4" class="form-control"></textarea>
  </div>

  <div class="mb-3">
    <button id="locateBtn" class="btn btn-outline-secondary" type="button">Use my location</button>
  </div>

  <div class="mb-3">
    <style>
      #map { height: 420px; border: 1px solid #ddd; border-radius: 6px; }
    </style>
    <div id="map"></div>
    <p class="mt-2">Selected location: <strong id="coordsDisplay">Not selected</strong></p>
  </div>

  <input type="hidden" name="lat" value="">
  <input type="hidden" name="lng" value="">

  <div class="mb-3">
    <button type="submit" class="btn btn-primary">Submit Report</button>
    <a href="/reports" class="btn btn-secondary ms-2">Cancel</a>
  </div>
</form>

<!-- Leaflet CSS & JS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  // Initialize map
  const map = L.map("map").setView([28.6139, 77.209], 13); // Delhi default

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
  }).addTo(map);

  let marker;

  // Click on map to add marker
  map.on("click", function (e) {
    const { lat, lng } = e.latlng;

    if (marker) {
      marker.setLatLng([lat, lng]);
    } else {
      marker = L.marker([lat, lng]).addTo(map);
    }

    document.querySelector("input[name=lat]").value = lat;
    document.querySelector("input[name=lng]").value = lng;
    document.getElementById("coordsDisplay").textContent = `${lat.toFixed(
      5
    )}, ${lng.toFixed(5)}`;
  });

  // "Use my location" button
  document.getElementById("locateBtn").addEventListener("click", function () {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function (pos) {
        const { latitude, longitude } = pos.coords;
        map.setView([latitude, longitude], 15);

        if (marker) marker.setLatLng([latitude, longitude]);
        else marker = L.marker([latitude, longitude]).addTo(map);

        document.querySelector("input[name=lat]").value = latitude;
        document.querySelector("input[name=lng]").value = longitude;
        document.getElementById(
          "coordsDisplay"
        ).textContent = `${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;
      });
    } else {
      alert("Geolocation not supported by your browser.");
    }
  });
});
</script>

<%- include("../partials/footer") %>
