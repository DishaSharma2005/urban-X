<%- include("../partials/header") %>

<div class="row">
  <div class="col-12">
    <h1>Create a New Report</h1>
    <p class="text-muted">Click on map to drop a pin, or use "Use my location".</p>
  </div>
</div>

<form id="reportForm" action="/reports" method="POST" enctype="multipart/form-data" class="mt-3">
  <!-- Title -->
  <div class="mb-3">
    <label for="title" class="form-label">Title</label>
    <input type="text" name="title" id="title" class="form-control" required />
  </div>

  <!-- Description -->
  <div class="mb-3">
    <label for="description" class="form-label">Description</label>
    <textarea name="description" id="description" rows="4" class="form-control"></textarea>
  </div>

  <!-- Category -->
  <div class="mb-3">
    <label class="form-label">Problem Category</label>
    <select name="category" id="category" class="form-select" required>
      <option value="">-- Select Category --</option>
      <option value="infrastructure">Infrastructure</option>
      <option value="electric">Electric</option>
      <option value="waste">Waste</option>
    </select>
  </div>

  <!-- Sub-category (dynamic) -->
  <div class="mb-3">
    <label for="subCategory" class="form-label">Problem Type</label>
    <select name="subCategory" id="subCategory" class="form-select" required>
      <option value="">-- Select Sub-Category --</option>
    </select>
  </div>

  <!-- Extra Info -->
  <div class="mb-3">
    <label for="extraInfo" class="form-label">Additional Information</label>
    <textarea name="extraInfo" id="extraInfo" rows="3" class="form-control"></textarea>
  </div>

  <!-- Photo Upload -->
  <div class="mb-3">
    <label for="image" class="form-label">Upload Photo</label>
    <input type="file" name="image" id="image" class="form-control" accept="image/*">
  </div>

  <!-- Location -->
  <div class="mb-3">
    <button id="locateBtn" class="btn btn-outline-secondary" type="button">Use my location</button>
  </div>

  <div class="mb-3">
    <style>
      #map { height: 420px; border: 1px solid #ddd; border-radius: 6px; }
    </style>
    <div id="map"></div>
    <p class="mt-2">Selected location: 
      <strong id="coordsDisplay">Not selected</strong><br>
    </p>
  </div>

  <!-- hidden lat/lng/place -->
  <input type="hidden" name="lat" value="">
  <input type="hidden" name="lng" value="">
  <input type="hidden" name="place" value="">

  <div class="mb-3">
    <button type="submit" class="btn btn-primary">Submit Report</button>
    <a href="/reports" class="btn btn-secondary ms-2">Cancel</a>
  </div>
</form>

<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  // Dynamic subcategories
  const subCategories = {
    infrastructure: ["pothole", "road"],
    electric: ["streetlight", "powercut"],
    waste: ["waterlogging", "contaminatedwater"]
  };

  const categorySelect = document.getElementById("category");
  const subCategorySelect = document.getElementById("subCategory");

  categorySelect.addEventListener("change", function () {
    subCategorySelect.innerHTML = "<option value=''>-- Select Sub-Category --</option>";
    if (this.value && subCategories[this.value]) {
      subCategories[this.value].forEach(sc => {
        const opt = document.createElement("option");
        opt.value = sc;
        opt.textContent = sc.charAt(0).toUpperCase() + sc.slice(1);
        subCategorySelect.appendChild(opt);
      });
    }
  });

  // Leaflet Map
  const map = L.map("map").setView([28.6139, 77.209], 13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(map);

  let marker;

  function setLocation(lat, lng) {
    if (marker) marker.setLatLng([lat, lng]);
    else marker = L.marker([lat, lng]).addTo(map);

    document.querySelector("input[name=lat]").value = lat;
    document.querySelector("input[name=lng]").value = lng;
    document.getElementById("coordsDisplay").textContent = `${lat.toFixed(5)}, ${lng.toFixed(5)}`;

    // Reverse geocoding with Nominatim
    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1`)
      .then(res => res.json())
      .then(data => {
        const addr = data.address;
        const place = [
          addr.road,
          addr.suburb,
          addr.city,
          addr.postcode,
          addr.state,
          addr.country
        ].filter(Boolean).join(", ");
        document.getElementById("placeName").textContent = place || "Unknown";
        document.querySelector("input[name=place]").value = place;
      });
  }

  map.on("click", function (e) {
    setLocation(e.latlng.lat, e.latlng.lng);
  });

  document.getElementById("locateBtn").addEventListener("click", function () {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function (pos) {
        setLocation(pos.coords.latitude, pos.coords.longitude);
        map.setView([pos.coords.latitude, pos.coords.longitude], 15);
      });
    } else {
      alert("Geolocation not supported by your browser.");
    }
  });
});
</script>

<%- include("../partials/footer") %>
